<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Parcel Completed</title>
</head>
<body style="margin:0; padding:20px; background-color:#f4f4f4; font-family:Arial,sans-serif;">
  <div style="max-width:900px; margin:auto; background:white; padding:20px; border-radius:8px; border:1px solid #d4e0df;">
    
    <!-- Logo -->
    <div style="text-align:center;">
      <img src="<%= adminData.logo %>" alt="Logo" style="width:100px;" />
    </div>

    <!-- Header -->
    <h2 style="color:#28a745; font-weight:600; margin-top:30px;">
      Parcel Delivered Successfully!
    </h2>
    <p>
      Congratulations! Your parcel <strong><%= order?.parcels[0]?.parcel_number %></strong> has been <strong>marked as completed</strong>. All stages of the delivery have been successfully finished.
    </p>

    <!-- Booking & Stage -->
    <table style="width:100%; margin-top:20px; border-collapse:collapse; border:1px solid #ddd;">
      <tbody>
        <tr>
          <td style="padding:13px; width:40%; font-weight:bold;">Booking ID</td>
          <td style="padding:13px;"><%= order.booking_id %></td>
        </tr>
        <tr>
          <td style="padding:13px; font-weight:bold;">Final Stage</td>
          <td style="padding:13px;">Stage <%= stage.id %> - <%= stage.status %></td>
        </tr>
      </tbody>
    </table>

    <!-- Pickup & Drop-off -->
    <table style="width:100%; margin-top:10px; border-collapse:collapse;">
      <tr>
        <td style="width:50%; padding:10px;">
          <strong>Pickup Location</strong><br />
          <%= order.source_address %>, <%= order.source_city %><br />
          <%= order.source_postcode %>
        </td>
        <td style="width:50%; padding:10px;">
          <strong>Drop-off Location</strong><br />
          <%= order.dest_address %>, <%= order.dest_city %><br />
          <%= order.dest_postcode %>
        </td>
      </tr>
    </table>

    <!-- Parcels -->
    <% if(order.parcels && order.parcels.length > 0){ %>
    <table style="width:100%; margin-top:20px; border-collapse:collapse; border:1px solid #ddd;">
      <thead>
        <tr style="background-color:#ed1c24; color:white; text-align:left;">
          <th style="padding:13px; font-weight:600;">Parcel</th>
          <th style="padding:13px; font-weight:600;">Source</th>
          <th style="padding:13px; font-weight:600;">Destination</th>
        </tr>
      </thead>
      <tbody>
        <% order.parcels.forEach(parcel => { %>
          <% const dims = []; if(parcel.length) dims.push(parcel.length); if(parcel.width) dims.push(parcel.width); if(parcel.height) dims.push(parcel.height); if(parcel.weight) dims.push(parcel.weight); if(parcel.quantity) dims.push(parcel.quantity); %>
          <tr>
            <td style="padding:13px;">
              <%= parcel.parcel_number %><br />
              <%= dims.join(' x ') %>
            </td>
            <td style="padding:13px;"><%= parcel.source_address %></td>
            <td style="padding:13px;"><%= parcel.destination_address %></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
    <% } %>

    <!-- Totals -->
    <table style="width:100%; margin-top:20px; border-collapse:collapse; border:1px solid #ddd;">
      <tbody>
        <tr>
          <td style="padding:13px;" width="80%">Total Distance</td>
          <td style="padding:13px;" width="20%"><%= order.distance ? order.distance.toFixed(2) : '0.00' %> miles</td>
        </tr>
        <tr>
          <td style="padding:13px;" width="80%">Subtotal</td>
          <td style="padding:13px;" width="20%">£<%= ((order?.vehicle_price || 0) * (order?.distance || 0)).toFixed(2) %></td>
        </tr>
        <tr>
          <td style="padding:13px;" width="80%">Tax Amount</td>
          <td style="padding:13px;" width="20%">£<%= order.tax || 0 %></td>
        </tr>
        <tr>
          <td style="padding:13px;" width="80%">Total Amount</td>
          <td style="padding:13px;" width="20%">£<%= order.total_amount || 0 %></td>
        </tr>
      </tbody>
    </table>

    <!-- Stage Status -->
    <table style="width:100%; margin-top:20px; border-collapse:collapse; border:1px solid #ddd;">
      <thead>
        <tr style="background-color:#ed1c24; color:white; text-align:left;">
          <th style="padding:13px; font-weight:600;">Stage</th>
          <th style="padding:13px; font-weight:600;">Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding:13px;">Stage <%= stage.id %></td>
          <td style="padding:13px;"><%= stage.status %></td>
        </tr>
      </tbody>
    </table>

    <!-- Updated Total -->
    <table style="width:100%; margin-top:20px; border-collapse:collapse; border:1px solid #ddd;">
      <tbody>
        <tr>
          <td style="padding:13px;" width="80%">Updated Total Amount</td>
          <td style="padding:13px;" width="20%">£<%= order.total_amount || 0 %></td>
        </tr>
      </tbody>
    </table>

    <!-- Track Order -->
    <div style="text-align:center; margin-top:20px;">
      <p style="font-size:14px; color:#555;">
        Thank you for using our service! You can view your delivery details or track your parcel using the button below.
      </p>
      <a href="https://fastukcouriers.com/order-tracking?tracking_id=<%= order.tracking_id %>"
         style="display:inline-block; margin-top:10px; background:#077eff; color:#fff; text-decoration:none; padding:10px 30px; border-radius:50px; font-weight:500;">
         Track Parcel
      </a>
    </div>

  </div>
</body>
</html>
